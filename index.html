<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SecureCore X ⚡</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Inter,sans-serif;height:100vh;display:flex;justify-content:center;align-items:center;background:url('https://source.unsplash.com/1600x900/?technology,abstract') no-repeat center center fixed;background-size:cover;position:relative;color:white}
body::before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:0}
.container{position:relative;z-index:1;width:95%;max-width:1200px;height:90vh;background:rgba(0,0,0,0.6);border-radius:15px;padding:20px;display:flex;flex-direction:column;box-shadow:0 0 20px rgba(255,111,145,0.7);}
h1{font-family:Orbitron;text-align:center;font-size:32px;margin-bottom:15px;color:#ff6f91;}
input,select{padding:10px;border:none;border-radius:10px;margin:5px 0;width:100%;background:#1c2a38;color:white;border:1px solid #ff6f91;}
input:focus,select:focus{outline:none;border:1px solid #ffd166;}
button{padding:10px;border:none;border-radius:10px;margin:5px 0;cursor:pointer;font-weight:bold;background:#ff6f91;color:white;transition:0.2s;}
button:hover{opacity:0.9; transform: scale(1.05);}
#chat{flex:1;overflow:auto;margin:10px 0;padding:10px;border-radius:10px;background:#203a43cc;}
.message{padding:10px;margin-bottom:10px;border-radius:10px;background:#30475ecc;display:flex;flex-direction:column;position:relative;transition:0.3s;}
.message:hover{box-shadow:0 0 15px #ff6f91; transform: scale(1.02);}
.small{font-size:11px;opacity:0.6;}
.delete{background:#ff4444;padding:4px 8px;font-size:11px;margin-top:5px;cursor:pointer;border:none;border-radius:5px;}
.decoded{color:#ffd166;font-weight:bold;}
.online{font-size:12px;text-align:right;opacity:0.7;margin-bottom:5px;}
.avatar{width:28px;height:28px;border-radius:50%;margin-right:6px;}
.userRow{display:flex;align-items:center;}
.videoPanel{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
video{width:200px;height:150px;background:#000;border-radius:10px;object-fit:cover;}
.controls{display:flex;gap:10px;margin-bottom:5px;}
</style>
</head>
<body>

<div class="container">
<h1>SecureCore X ⚡</h1>

<div id="loginBox">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Şifre">
  <input id="nickname" placeholder="Takma ad">
  <input id="avatarURL" placeholder="Profil resmi URL (opsiyonel)">
  <button onclick="login()">Giriş Yap</button>
</div>

<div id="appBox" style="display:none;flex:1;flex-direction:column;">
  <input id="room" placeholder="Oda adı">
  <input id="secretKey" placeholder="Ortak Gizli Anahtar">
  <div class="controls">
    <button id="toggleMic">Mikrofon Aç/Kapat</button>
    <button id="toggleCam">Kamera Aç/Kapat</button>
  </div>
  <div class="online" id="onlineCount"></div>
  <div id="chat"></div>
  <input id="mesaj" placeholder="Mesaj yaz...">
  <input type="file" id="dosya">
  <button onclick="sendMessage()">Gönder</button>
  <div class="videoPanel" id="videoPanel"></div>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyB9hBRTJ4BLMLpmAPxwPdbrNbk2UuAV3i4",
  authDomain: "core-chat-3be96.firebaseapp.com",
  databaseURL: "https://core-chat-3be96-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "core-chat-3be96",
  storageBucket: "core-chat-3be96.appspot.com",
  messagingSenderId: "555994455959",
  appId: "1:555994455959:web:9dbd659b1970c491042ed2"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// Login
function login(){
  if(!nickname.value) return alert("Takma ad boş olamaz!");
  auth.signInWithEmailAndPassword(email.value,password.value)
  .then(async ()=>{
    const uid=auth.currentUser.uid;
    await db.ref("users/"+uid).set({nickname:nickname.value,avatar:avatarURL.value||''});
    loginBox.style.display="none"; appBox.style.display="flex";
    startLocalStream();
  }).catch(e=>alert(e.message));
}
auth.onAuthStateChanged(user=>{if(user){loginBox.style.display="none";appBox.style.display="flex";startLocalStream();}});

// --- Chat kısmı aynen önceki sürüm ---
// (AES şifreli text ve dosya chat kodları buraya aynen kopyalanabilir)
let lastSent=0;
async function getKey(password){const enc=new TextEncoder();const hash=await crypto.subtle.digest("SHA-256",enc.encode(password));return crypto.subtle.importKey("raw",hash,{name:"AES-GCM"},false,["encrypt","decrypt"]);}
function ab2b64(buffer){return btoa(String.fromCharCode(...new Uint8Array(buffer)));}
function b642ab(base64){return Uint8Array.from(atob(base64),c=>c.charCodeAt(0));}
function escapeHTML(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML;}

// --- WebRTC Video/Audio ---
let localStream=null;
const peers={}; // uid -> RTCPeerConnection
const videoPanel=document.getElementById("videoPanel");
let currentRoom=null;

async function startLocalStream(){
  try{
    localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    addVideoStream(localStream,"Ben");
    if(room.value) joinRoom(room.value);
  }catch(err){console.error(err);}
}

function addVideoStream(stream,label){
  const vid=document.createElement("video");
  vid.srcObject=stream; vid.autoplay=true; vid.playsInline=true;
  const container=document.createElement("div");
  container.appendChild(vid);
  const lbl=document.createElement("div");
  lbl.textContent=label; lbl.style.color="#ffd166"; lbl.style.fontSize="12px";
  container.appendChild(lbl);
  videoPanel.appendChild(container);
}

// Mic / Cam toggle
document.getElementById("toggleMic").onclick=()=>{if(localStream)localStream.getAudioTracks()[0].enabled=!localStream.getAudioTracks()[0].enabled;}
document.getElementById("toggleCam").onclick=()=>{if(localStream)localStream.getVideoTracks()[0].enabled=!localStream.getVideoTracks()[0].enabled;}

// Join room for WebRTC
function joinRoom(roomName){
  if(currentRoom) db.ref("roomsRTC/"+currentRoom).off();
  currentRoom=roomName;
  const myUid=auth.currentUser.uid;
  const rtcRef=db.ref("roomsRTC/"+roomName);

  rtcRef.on("child_added",async snap=>{
    const data=snap.val();
    const sender=data.uid;
    if(sender===myUid) return;
    if(!peers[sender]) createPeer(sender,false);
    const peer=peers[sender];
    if(data.offer && !peer.remoteDescription){
      await peer.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer=await peer.createAnswer();
      await peer.setLocalDescription(answer);
      rtcRef.push({uid:myUid,answer:answer});
    }
    if(data.answer && peer && !peer.remoteDescription){
      await peer.setRemoteDescription(new RTCSessionDescription(data.answer));
    }
    if(data.candidate && peer){
      try{await peer.addIceCandidate(new RTCIceCandidate(data.candidate));}catch(e){console.error(e);}
    }
  });

  // Notify others
  rtcRef.once("value",snap=>{
    Object.keys(snap.val()||{}).forEach(k=>{
      const u=snap.val()[k].uid;
      if(u!==myUid && !peers[u]) createPeer(u,true);
    });
  });
}

function createPeer(uid,isInitiator){
  const pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
  peers[uid]=pc;
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));

  pc.ontrack=e=>{addVideoStream(e.streams[0],"Diğer");};
  pc.onicecandidate=e=>{if(e.candidate)db.ref("roomsRTC/"+currentRoom).push({uid:auth.currentUser.uid,candidate:e.candidate});};

  if(isInitiator){
    pc.createOffer().then(offer=>{
      pc.setLocalDescription(offer);
      db.ref("roomsRTC/"+currentRoom).push({uid:auth.currentUser.uid,offer:offer});
    });
  }
}
</script>
</body>
</html>
