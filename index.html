<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SecureCore X</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:Inter,sans-serif;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
}

.container{
  width:95%;
  max-width:1100px;
  height:95vh;
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(25px);
  border-radius:20px;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  box-shadow:0 20px 60px rgba(0,0,0,0.7);
}

header{
  padding:15px;
  text-align:center;
  font-family:Orbitron;
  font-size:20px;
  color:#00f5ff;
  background:rgba(0,0,0,0.3);
}

.topInputs{
  display:flex;
  gap:10px;
  padding:10px;
  flex-wrap:wrap;
}

.topInputs input{
  flex:1;
  padding:10px;
  border:none;
  border-radius:12px;
  background:#1c2a38;
  color:white;
}

#chat{
  flex:1;
  overflow-y:auto;
  padding:15px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.message{
  max-width:70%;
  padding:12px 16px;
  border-radius:20px;
  font-size:14px;
  animation:fadeIn .2s ease;
}

.left{
  align-self:flex-start;
  background:linear-gradient(135deg,#1f1f1f,#2b2b2b);
  border-bottom-left-radius:5px;
}

.right{
  align-self:flex-end;
  background:linear-gradient(135deg,#00f5ff,#00bcd4);
  color:black;
  border-bottom-right-radius:5px;
}

.username{
  font-size:11px;
  font-weight:600;
  opacity:0.8;
  margin-bottom:4px;
}

.timestamp{
  font-size:10px;
  opacity:0.6;
  margin-top:4px;
  text-align:right;
}

.inputArea{
  display:flex;
  gap:10px;
  padding:10px;
  background:rgba(0,0,0,0.4);
}

.inputArea input{
  flex:1;
  padding:12px;
  border:none;
  border-radius:15px;
  background:#1c2a38;
  color:white;
}

.inputArea button{
  padding:10px 15px;
  border:none;
  border-radius:15px;
  background:#00f5ff;
  color:black;
  font-weight:bold;
  cursor:pointer;
}

.videoArea{
  display:flex;
  gap:10px;
  padding:10px;
}

video{
  width:50%;
  border-radius:15px;
  background:black;
}

.callButtons{
  display:flex;
  gap:10px;
  padding:10px;
  justify-content:center;
  flex-wrap:wrap;
}

.callButtons button{
  padding:8px 15px;
  border:none;
  border-radius:12px;
  background:#00f5ff;
  font-weight:bold;
  cursor:pointer;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px);}
  to{opacity:1;transform:translateY(0);}
}
</style>
</head>
<body>

<div class="container">

<header>SecureCore X ⚡</header>

<div class="topInputs">
  <input id="username" placeholder="Kullanıcı Adın">
  <input id="room" placeholder="Oda adı">
  <input id="secretKey" placeholder="Ortak Gizli Anahtar">
</div>

<div id="chat"></div>

<div class="inputArea">
  <input id="mesaj" placeholder="Mesaj yaz...">
  <button onclick="sendMessage()">Gönder</button>
</div>

<div class="videoArea">
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>
</div>

<div class="callButtons">
  <button onclick="startCall()">Arama Başlat</button>
  <button onclick="joinCall()">Katıl</button>
  <button onclick="endCall()">Bitir</button>
  <button onclick="toggleMic()">Mic</button>
  <button onclick="toggleCam()">Cam</button>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig={
  apiKey:"AIzaSyB9hBRTJ4BLMLpmAPxwPdbrNbk2UuAV3i4",
  authDomain:"core-chat-3be96.firebaseapp.com",
  databaseURL:"https://core-chat-3be96-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"core-chat-3be96"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let myId = localStorage.getItem("myId");
if(!myId){
  myId = "user_"+Math.random().toString(36).substring(2,9);
  localStorage.setItem("myId",myId);
}

async function getKey(password){
  const enc=new TextEncoder();
  const hash=await crypto.subtle.digest("SHA-256",enc.encode(password));
  return crypto.subtle.importKey("raw",hash,{name:"AES-GCM"},false,["encrypt","decrypt"]);
}

function ab2b64(buffer){
  return btoa(String.fromCharCode(...new Uint8Array(buffer)));
}

function b642ab(base64){
  return Uint8Array.from(atob(base64),c=>c.charCodeAt(0));
}

async function sendMessage(){
  if(!room.value||!secretKey.value||!mesaj.value||!username.value) return;

  const key=await getKey(secretKey.value);
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const cipher=await crypto.subtle.encrypt(
    {name:"AES-GCM",iv:iv},
    key,
    new TextEncoder().encode(mesaj.value)
  );

  const combined=new Uint8Array(iv.length+cipher.byteLength);
  combined.set(iv,0);
  combined.set(new Uint8Array(cipher),iv.length);

  db.ref("rooms/"+room.value).push({
    message:ab2b64(combined),
    time:Date.now(),
    sender:myId,
    name:username.value
  });

  mesaj.value="";
}

room.addEventListener("change",()=>{
  chat.innerHTML="";
  db.ref("rooms/"+room.value).off();

  db.ref("rooms/"+room.value).on("child_added",async snap=>{
    const data=snap.val();
    try{
      const key=await getKey(secretKey.value);
      const raw=b642ab(data.message);
      const iv=raw.slice(0,12);
      const cipher=raw.slice(12);
      const dec=await crypto.subtle.decrypt({name:"AES-GCM",iv:iv},key,cipher);
      const text=new TextDecoder().decode(dec);

      const div=document.createElement("div");
      const isMe = data.sender === myId;
      div.className="message "+(isMe?"right":"left");

      div.innerHTML=`
        <div class="username">${data.name}</div>
        ${text}
        <div class="timestamp">${new Date(data.time).toLocaleTimeString()}</div>
      `;

      chat.appendChild(div);
      chat.scrollTop=chat.scrollHeight;

    }catch{}
  });
});

// WebRTC
let localStream;
let peerConnection;
const servers={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

async function initMedia(){
  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject=localStream;
}

async function createPeer(){
  peerConnection=new RTCPeerConnection(servers);

  localStream.getTracks().forEach(track=>{
    peerConnection.addTrack(track,localStream);
  });

  peerConnection.ontrack=e=>{
    remoteVideo.srcObject=e.streams[0];
  };

  peerConnection.onicecandidate=e=>{
    if(e.candidate){
      db.ref("calls/"+room.value+"/candidates").push(e.candidate.toJSON());
    }
  };

  db.ref("calls/"+room.value+"/candidates")
  .on("child_added",snap=>{
    if(peerConnection){
      peerConnection.addIceCandidate(new RTCIceCandidate(snap.val()));
    }
  });
}

async function startCall(){
  await initMedia();
  await createPeer();

  const offer=await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);
  await db.ref("calls/"+room.value+"/offer").set(offer);

  db.ref("calls/"+room.value+"/answer")
  .on("value",async snap=>{
    const answer=snap.val();
    if(answer){
      await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
    }
  });
}

async function joinCall(){
  await initMedia();
  await createPeer();

  const offerSnap=await db.ref("calls/"+room.value+"/offer").get();
  const offer=offerSnap.val();

  await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
  const answer=await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);
  await db.ref("calls/"+room.value+"/answer").set(answer);
}

function endCall(){
  if(peerConnection)peerConnection.close();
  if(localStream)localStream.getTracks().forEach(t=>t.stop());
  db.ref("calls/"+room.value).remove();
}

function toggleMic(){
  if(localStream)localStream.getAudioTracks()[0].enabled =
  !localStream.getAudioTracks()[0].enabled;
}

function toggleCam(){
  if(localStream)localStream.getVideoTracks()[0].enabled =
  !localStream.getVideoTracks()[0].enabled;
}
</script>

</body>
</html>
