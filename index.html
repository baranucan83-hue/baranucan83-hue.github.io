<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SecureCore X âš¡</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:Inter,sans-serif;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background: url('https://source.unsplash.com/1600x900/?technology,abstract') no-repeat center center fixed;
  background-size: cover;
  position: relative;
  color:white;
}
body::before{
  content:"";
  position:absolute;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.5);
  z-index:0;
}
.container{
  position: relative;
  z-index:1;
  width:95%;
  max-width:900px;
  height:90vh;
  background: rgba(0,0,0,0.6);
  border-radius:15px;
  padding:20px;
  display:flex;
  flex-direction:column;
  box-shadow:0 0 20px rgba(255,111,145,0.7);
}
h1{
  font-family:Orbitron;
  text-align:center;
  font-size:32px;
  margin-bottom:15px;
  color:#ff6f91;
}
input{
  padding:12px;
  border:none;
  border-radius:10px;
  margin:5px 0;
  width:100%;
  background:#1c2a38;
  color:white;
  border:1px solid #ff6f91;
}
input:focus{outline:none;border:1px solid #ffd166;}
button{
  padding:10px;
  border:none;
  border-radius:10px;
  margin:5px 0;
  cursor:pointer;
  font-weight:bold;
  background:#ff6f91;
  color:white;
  transition:0.2s;
}
button:hover{opacity:0.9; transform: scale(1.05);}
#chat{
  flex:1;
  overflow:auto;
  margin:10px 0;
  padding:10px;
  border-radius:10px;
  background:#203a43cc;
}
.message{
  padding:10px;
  margin-bottom:10px;
  border-radius:10px;
  background:#30475ecc;
  display:flex;
  flex-direction:column;
  position:relative;
  transition: 0.3s;
}
.message:hover{box-shadow: 0 0 15px #ff6f91; transform: scale(1.02);}
.small{font-size:11px;opacity:0.6;}
.delete{
  background:#ff4444;
  padding:4px 8px;
  font-size:11px;
  margin-top:5px;
  cursor:pointer;
  border:none;
  border-radius:5px;
}
.decoded{
  color:#ffd166;
  font-weight:bold;
}
.online{
  font-size:12px;
  text-align:right;
  opacity:0.7;
  margin-bottom:5px;
}
.avatar{
  width:28px; height:28px; border-radius:50%; margin-right:6px;
}
.userRow{
  display:flex; align-items:center;
}
</style>
</head>
<body>

<div class="container">
<h1>SecureCore X âš¡</h1>

<div id="loginBox">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Åžifre">
  <input id="nickname" placeholder="Takma ad">
  <input id="avatarURL" placeholder="Profil resmi URL (opsiyonel)">
  <button onclick="login()">GiriÅŸ Yap</button>
</div>

<div id="appBox" style="display:none;flex:1;flex-direction:column;">
  <input id="room" placeholder="Oda adÄ±">
  <input id="secretKey" placeholder="Ortak Gizli Anahtar">
  <div class="online" id="onlineCount"></div>
  <div id="chat"></div>
  <input id="mesaj" placeholder="Mesaj yaz...">
  <input type="file" id="dosya">
  <button onclick="sendMessage()">GÃ¶nder</button>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB9hBRTJ4BLMLpmAPxwPdbrNbk2UuAV3i4",
  authDomain: "core-chat-3be96.firebaseapp.com",
  databaseURL: "https://core-chat-3be96-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "core-chat-3be96",
  storageBucket: "core-chat-3be96.appspot.com",
  messagingSenderId: "555994455959",
  appId: "1:555994455959:web:9dbd659b1970c491042ed2"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// Login
function login(){
  if(!nickname.value) return alert("Takma ad boÅŸ olamaz!");
  auth.signInWithEmailAndPassword(email.value,password.value)
  .then(async ()=>{
    const uid = auth.currentUser.uid;
    await db.ref("users/"+uid).set({
      nickname: nickname.value,
      avatar: avatarURL.value || ''
    });
    loginBox.style.display="none";
    appBox.style.display="flex";
  })
  .catch(e=>alert(e.message));
}

auth.onAuthStateChanged(user=>{
  if(user){loginBox.style.display="none"; appBox.style.display="flex";}
});

// Encryption helpers
async function getKey(password){
  const enc = new TextEncoder();
  const hash = await crypto.subtle.digest("SHA-256", enc.encode(password));
  return crypto.subtle.importKey("raw", hash, {name:"AES-GCM"}, false, ["encrypt","decrypt"]);
}
function ab2b64(buffer){ return btoa(String.fromCharCode(...new Uint8Array(buffer))); }
function b642ab(base64){ return Uint8Array.from(atob(base64), c=>c.charCodeAt(0)); }
function escapeHTML(text){ const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

// Rate limit
let lastSent = 0;

// Send message or file
async function sendMessage(){
  const now = Date.now();
  if(now - lastSent < 1000) return alert("1 saniyede bir mesaj gÃ¶nderebilirsiniz");
  lastSent = now;
  if(!room.value || !secretKey.value || (!mesaj.value && !dosya.files.length)) return alert("Alanlar boÅŸ olamaz");

  const key = await getKey(secretKey.value);
  let type = dosya.files.length ? "file" : "text";
  let messageData = {};

  if(type==="text"){
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const enc = new TextEncoder();
    const cipher = await crypto.subtle.encrypt({name:"AES-GCM",iv:iv},key,enc.encode(mesaj.value));
    const combined = new Uint8Array(iv.length + cipher.byteLength);
    combined.set(iv,0);
    combined.set(new Uint8Array(cipher),iv.length);
    messageData = {data:ab2b64(combined)};
  } else {
    const file = dosya.files[0];
    const arrayBuffer = await file.arrayBuffer();
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const cipher = await crypto.subtle.encrypt({name:"AES-GCM",iv:iv},key,arrayBuffer);
    const combined = new Uint8Array(iv.length + cipher.byteLength);
    combined.set(iv,0);
    combined.set(new Uint8Array(cipher),iv.length);
    messageData = {data:ab2b64(combined),name:file.name,type:file.type};
  }

  const userRef = db.ref("users/"+auth.currentUser.uid);
  const userData = (await userRef.get()).val();

  db.ref("rooms/"+room.value).push({
    message: JSON.stringify(messageData),
    user: auth.currentUser.email,
    nickname: userData.nickname,
    avatar: userData.avatar || '',
    time: Date.now(),
    type: type
  });

  mesaj.value=""; dosya.value="";
}

mesaj.addEventListener("keypress", e=>{if(e.key==="Enter") sendMessage();});

let currentRoom = null;
const colors = ["#ff4444","#00ffff","#ffaa00","#00ff00","#ff00ff","#ff6f91"];

room.addEventListener("change", ()=>{
  chat.innerHTML="";
  if(currentRoom) db.ref("rooms/"+currentRoom).off();
  currentRoom = room.value;

  db.ref("rooms/"+currentRoom).on("child_added", async snap=>{
    const data = snap.val();
    const id = snap.key;
    const messageRef = db.ref("rooms/"+currentRoom+"/"+id);

    const div = document.createElement("div");
    div.className="message";
    const userColor = colors[data.nickname.charCodeAt(0) % colors.length];

    let text="ðŸ”’ Mesaj Ã§Ã¶zÃ¼lemedi!";
    try{
      const key = await getKey(secretKey.value);
      const msgObj = JSON.parse(data.message);
      if(data.type==="text"){
        const raw = b642ab(msgObj.data);
        const iv = raw.slice(0,12);
        const cipher = raw.slice(12);
        const dec = await crypto.subtle.decrypt({name:"AES-GCM",iv:iv},key,cipher);
        text = escapeHTML(new TextDecoder().decode(dec));
      } else {
        const raw = b642ab(msgObj.data);
        const iv = raw.slice(0,12);
        const cipher = raw.slice(12);
        const dec = await crypto.subtle.decrypt({name:"AES-GCM",iv:iv},key,cipher);
        const blob = new Blob([dec],{type:msgObj.type});
        if(msgObj.type.startsWith("image/")){
          text = `<img src="${URL.createObjectURL(blob)}" style="max-width:100%;border-radius:10px;">`;
        } else {
          text = `<a href="${URL.createObjectURL(blob)}" download="${escapeHTML(msgObj.name)}" style="color:#ffd166;">${escapeHTML(msgObj.name)}</a>`;
        }
      }
    }catch{}

    const avatarImg = data.avatar ? `<img src="${escapeHTML(data.avatar)}" class="avatar">` : '';
    div.innerHTML = `<div class="userRow">${avatarImg}<b style="color:${userColor}">${escapeHTML(data.nickname)}</b></div>
                     <div class="decoded">${text}</div>
                     <div class="small">${new Date(data.time).toLocaleString()}</div>`;

    if(auth.currentUser.email===data.user){
      const del = document.createElement("button");
      del.textContent="Sil";
      del.className="delete";
      del.onclick = ()=> { messageRef.remove().catch(err=>alert("Silme hatasÄ±: "+err.message)); };
      div.appendChild(del);
    }

    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  });

  db.ref("rooms/"+currentRoom).on("value", snap=>{
    onlineCount.textContent = "Mesaj SayÄ±sÄ±: " + snap.numChildren();
  });
});
</script>
</body>
</html>
