<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SecureCore X ðŸŒŒ</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:Inter,sans-serif;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background: #1e2a38; /* huzur veren gece mavisi */
  color:white;
}
.container{
  width:95%;
  max-width:900px;
  height:90vh;
  background:#2a3b4d; /* biraz daha aÃ§Ä±k ton */
  border-radius:15px;
  padding:20px;
  display:flex;
  flex-direction:column;
  box-shadow:0 0 15px rgba(0,0,0,0.5);
}
h1{
  font-family:Orbitron;
  text-align:center;
  font-size:32px;
  margin-bottom:15px;
  color:#a0e7ff;
}
input{
  padding:12px;
  border:none;
  border-radius:10px;
  margin:5px 0;
  width:100%;
  background:#3b4f63;
  color:white;
  border:1px solid #a0e7ff;
}
input:focus{outline:none;border:1px solid #ffd6a5;}
button{
  padding:10px;
  border:none;
  border-radius:10px;
  margin:5px 0;
  cursor:pointer;
  font-weight:bold;
  background:#00b4d8;
  color:white;
}
button:hover{opacity:0.9;}
#chat{
  flex:1;
  overflow:auto;
  margin:10px 0;
  padding:10px;
  border-radius:10px;
  background:#3b4f63;
}
.message{
  padding:10px;
  margin-bottom:10px;
  border-radius:10px;
  background:#41668c;
  display:flex;
  flex-direction:column;
  position:relative;
}
.small{font-size:11px;opacity:0.6;}
.delete{
  background:#ff6b6b;
  padding:4px 8px;
  font-size:11px;
  margin-top:5px;
  cursor:pointer;
  border:none;
  border-radius:5px;
}
.decoded{
  color:#ffd166;
  font-weight:bold;
}
.online{
  font-size:12px;
  text-align:right;
  opacity:0.7;
  margin-bottom:5px;
}
</style>
</head>
<body>

<div class="container">
<h1>SecureCore X ðŸŒŒ</h1>

<div id="loginBox">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Åžifre">
  <button onclick="login()">GiriÅŸ Yap</button>
</div>

<div id="appBox" style="display:none;flex:1;flex-direction:column;">
  <input id="room" placeholder="Oda adÄ±">
  <input id="secretKey" placeholder="Ortak Gizli Anahtar">
  <div class="online" id="onlineCount"></div>
  <div id="chat"></div>
  <input id="mesaj" placeholder="Mesaj yaz...">
  <button onclick="sendMessage()">GÃ¶nder</button>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB9hBRTJ4BLMLpmAPxwPdbrNbk2UuAV3i4",
  authDomain: "core-chat-3be96.firebaseapp.com",
  databaseURL: "https://core-chat-3be96-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "core-chat-3be96",
  storageBucket: "core-chat-3be96.firebasestorage.app",
  messagingSenderId: "555994455959",
  appId: "1:555994455959:web:9dbd659b1970c491042ed2"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

function login(){
  auth.signInWithEmailAndPassword(email.value,password.value)
  .then(()=>{loginBox.style.display="none"; appBox.style.display="flex";})
  .catch(e=>alert(e.message));
}

auth.onAuthStateChanged(user=>{
  if(user){loginBox.style.display="none"; appBox.style.display="flex";}
});

async function getKey(password){
  const enc = new TextEncoder();
  const hash = await crypto.subtle.digest("SHA-256",enc.encode(password));
  return crypto.subtle.importKey("raw",hash,{name:"AES-GCM"},false,["encrypt","decrypt"]);
}

function ab2b64(buffer){ return btoa(String.fromCharCode(...new Uint8Array(buffer))); }
function b642ab(base64){ return Uint8Array.from(atob(base64),c=>c.charCodeAt(0)); }

async function sendMessage(){
  if(!room.value || !secretKey.value || !mesaj.value) return alert("Alanlar boÅŸ olamaz");
  const key = await getKey(secretKey.value);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const enc = new TextEncoder();
  const cipher = await crypto.subtle.encrypt({name:"AES-GCM",iv:iv},key,enc.encode(mesaj.value));
  const combined = new Uint8Array(iv.length + cipher.byteLength);
  combined.set(iv,0);
  combined.set(new Uint8Array(cipher),iv.length);
  db.ref("rooms/"+room.value).push({message: ab2b64(combined), user: auth.currentUser.email, time: Date.now()});
  mesaj.value="";
}

mesaj.addEventListener("keypress", e=>{if(e.key==="Enter") sendMessage();});

let currentRoom = null;
const colors = ["#ff4444","#00ffff","#ffaa00","#00ff00","#ff00ff"];

room.addEventListener("change",()=>{
  chat.innerHTML="";
  if(currentRoom) db.ref("rooms/"+currentRoom).off();
  currentRoom = room.value;

  db.ref("rooms/"+currentRoom).on("child_added", async snap=>{
    const data = snap.val();
    const id = snap.key;

    const div = document.createElement("div");
    div.className="message";
    const userColor = colors[data.user.charCodeAt(0) % colors.length];

    // MesajÄ± otomatik Ã§Ã¶z
    let text="ðŸ”’ Mesaj Ã§Ã¶zÃ¼lemedi!";
    try{
      const key = await getKey(secretKey.value);
      const raw = b642ab(data.message);
      const iv = raw.slice(0,12);
      const cipher = raw.slice(12);
      const dec = await crypto.subtle.decrypt({name:"AES-GCM",iv:iv},key,cipher);
      text = new TextDecoder().decode(dec);
    }catch{}

    div.innerHTML = `<b style="color:${userColor}">${data.user}</b>
                     <div class="decoded">${text}</div>
                     <div class="small">${new Date(data.time).toLocaleString()}</div>`;

    if(auth.currentUser.email===data.user){
      const del = document.createElement("button");
      del.textContent="Sil";
      del.className="delete";
      del.onclick = ()=> db.ref("rooms/"+currentRoom+"/"+id).remove();
      div.appendChild(del);
    }

    chat.appendChild(div);
    chat.scrollTop=chat.scrollHeight;
  });

  db.ref("rooms/"+currentRoom).on("value", snap=>{
    onlineCount.textContent = "Mesaj SayÄ±sÄ±: " + snap.numChildren();
  });
});
</script>
</body>
</html>
