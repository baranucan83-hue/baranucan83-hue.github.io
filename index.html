<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SecureCore X</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:Inter,sans-serif;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:radial-gradient(circle at 20% 20%,#00f0ff22,#000814 60%);
  overflow:hidden;
  color:white;
}

body::before{
  content:"";
  position:absolute;
  width:200%;
  height:200%;
  background:conic-gradient(from 0deg,#00f0ff,#8a2be2,#00f0ff);
  animation:spin 12s linear infinite;
  opacity:0.1;
}
@keyframes spin{
  from{transform:rotate(0deg)}
  to{transform:rotate(360deg)}
}

.container{
  position:relative;
  width:95%;
  max-width:950px;
  height:90vh;
  backdrop-filter:blur(25px);
  background:rgba(255,255,255,0.05);
  border-radius:25px;
  padding:25px;
  box-shadow:0 0 50px #00f0ff44;
  display:flex;
  flex-direction:column;
}

h1{
  font-family:Orbitron;
  text-align:center;
  font-size:28px;
  margin-bottom:15px;
  letter-spacing:2px;
}

input{
  padding:12px;
  border:none;
  border-radius:12px;
  margin:6px 0;
  width:100%;
  background:rgba(255,255,255,0.08);
  color:white;
}

button{
  padding:10px;
  border:none;
  border-radius:12px;
  margin:6px 0;
  cursor:pointer;
  font-weight:bold;
  background:linear-gradient(45deg,#00f0ff,#8a2be2);
  color:white;
  transition:0.3s;
}
button:hover{transform:scale(1.05)}

#chat{
  flex:1;
  overflow:auto;
  margin:10px 0;
  padding:10px;
  border-radius:15px;
  background:rgba(0,0,0,0.25);
}

.message{
  padding:10px;
  margin-bottom:10px;
  border-radius:12px;
  background:rgba(255,255,255,0.08);
  animation:fadeIn 0.4s ease;
}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

.small{font-size:11px;opacity:0.6}

.delete{
  background:#ff3b3b;
  padding:4px 8px;
  font-size:11px;
  margin-top:5px;
}

.online{
  font-size:12px;
  text-align:right;
  opacity:0.7;
}
</style>
</head>
<body>

<div class="container">

<h1>SecureCore X üîê</h1>

<div id="loginBox">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="≈ûifre">
  <button onclick="login()">Giri≈ü Yap</button>
</div>

<div id="appBox" style="display:none;flex:1;flex-direction:column;">
  <input id="room" placeholder="Oda adƒ±">
  <input id="secretKey" placeholder="Ortak Gizli Anahtar">
  <div class="online" id="onlineCount"></div>
  <div id="chat"></div>
  <input id="mesaj" placeholder="Mesaj yaz...">
  <button onclick="sendMessage()">G√∂nder</button>
</div>

</div>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
// üîπ Yeni Firebase config (compat uyumlu)
const firebaseConfig = {
  apiKey: "AIzaSyB9hBRTJ4BLMLpmAPxwPdbrNbk2UuAV3i4",
  authDomain: "core-chat-3be96.firebaseapp.com",
  databaseURL: "https://core-chat-3be96-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "core-chat-3be96",
  storageBucket: "core-chat-3be96.firebasestorage.app",
  messagingSenderId: "555994455959",
  appId: "1:555994455959:web:9dbd659b1970c491042ed2",
  measurementId: "G-MK4ZWQE0GG"
};

// Firebase ba≈ülatma (compat s√ºr√ºm)
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// üîπ Giri≈ü Fonksiyonu
function login(){
  auth.signInWithEmailAndPassword(email.value,password.value)
  .then(()=>{
    loginBox.style.display="none";
    appBox.style.display="flex";
  })
  .catch(e=>alert(e.message));
}

auth.onAuthStateChanged(user=>{
  if(user){
    loginBox.style.display="none";
    appBox.style.display="flex";
  }
});

// üîπ Mesaj ≈üifreleme / √ß√∂zme
async function getKey(password){
  const enc = new TextEncoder();
  const hash = await crypto.subtle.digest("SHA-256",enc.encode(password));
  return crypto.subtle.importKey("raw",hash,{name:"AES-GCM"},false,["encrypt","decrypt"]);
}

function ab2b64(buffer){
  return btoa(String.fromCharCode(...new Uint8Array(buffer)));
}
function b642ab(base64){
  return Uint8Array.from(atob(base64),c=>c.charCodeAt(0));
}

// üîπ Mesaj g√∂nderme
async function sendMessage(){
  if(!room.value || !secretKey.value || !mesaj.value) return alert("Alanlar bo≈ü olamaz");

  const key = await getKey(secretKey.value);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const enc = new TextEncoder();
  const cipher = await crypto.subtle.encrypt({name:"AES-GCM",iv:iv},key,enc.encode(mesaj.value));

  const combined = new Uint8Array(iv.length + cipher.byteLength);
  combined.set(iv,0);
  combined.set(new Uint8Array(cipher),iv.length);

  db.ref("rooms/" + room.value).push({
    message: ab2b64(combined),
    user: auth.currentUser.email,
    time: Date.now()
  });

  mesaj.value = "";
}

// üîπ Mesajlarƒ± dinleme
let currentRoom = null;

room.addEventListener("change",()=>{
  chat.innerHTML="";
  if(currentRoom) db.ref("rooms/"+currentRoom).off();
  currentRoom = room.value;

  db.ref("rooms/"+currentRoom).on("child_added", async snap=>{
    const data = snap.val();
    const id = snap.key;

    let text = "üîí Anahtar gerekli";
    try{
      const key = await getKey(secretKey.value);
      const raw = b642ab(data.message);
      const iv = raw.slice(0,12);
      const cipher = raw.slice(12);
      const dec = await crypto.subtle.decrypt({name:"AES-GCM",iv:iv},key,cipher);
      text = new TextDecoder().decode(dec);
    }catch{}

    const div = document.createElement("div");
    div.className="message";
    div.innerHTML=`<b>${data.user}</b><div>${text}</div><div class="small">${new Date(data.time).toLocaleString()}</div>`;

    if(auth.currentUser.email===data.user){
      const del=document.createElement("button");
      del.textContent="Sil";
      del.className="delete";
      del.onclick=()=>db.ref("rooms/"+currentRoom+"/"+id).remove();
      div.appendChild(del);
    }

    chat.appendChild(div);
    chat.scrollTop=chat.scrollHeight;
  });

  db.ref("rooms/"+currentRoom).on("value", snap=>{
    onlineCount.textContent="Mesaj Sayƒ±sƒ±: "+snap.numChildren();
  });
});
</script>

</body>
</html>
